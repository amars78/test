import streamlit as st
import pandas as pd
import folium
from streamlit_folium import st_folium
from geopy.distance import geodesic

# λ¨λ“  μ„Όν„° λ°μ΄ν„°
# [μ„Όν„°λ…, μ‹λ„λ…, μ‹κµ°κµ¬λ…, μ£Όμ†, μ„λ„, κ²½λ„]
data = [
    ["μ„μΈμ‹μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "μ¤‘κµ¬", "μ„μΈνΉλ³„μ‹ μ¤‘κµ¬ μ„μ§€λ΅ 11κΈΈ 23 7μΈµ", 37.566375, 126.990471],
    ["μΆ…λ΅κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "μΆ…λ΅κµ¬", "μ„μΈνΉλ³„μ‹ μΆ…λ΅κµ¬ λ…λ¥κΈΈ 90", 37.585501, 126.997992],
    ["μ©μ‚°κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "μ©μ‚°κµ¬", "μ„μΈνΉλ³„μ‹ μ©μ‚°κµ¬ λ°±λ²”λ΅ 329", 37.534241, 126.963403],
    ["μ„±λ™κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "μ„±λ™κµ¬", "μ„μΈνΉλ³„μ‹ μ„±λ™κµ¬ ν–‰λ‹Ήλ΅6κΈΈ 24-15", 37.561491, 127.026402],
    ["κ΄‘μ§„κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "κ΄‘μ§„κµ¬", "μ„μΈνΉλ³„μ‹ κ΄‘μ§„κµ¬ μ•„μ°¨μ‚°λ΅ 24κΈΈ 17", 37.534201, 127.067332],
    ["λ™λ€λ¬Έκµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "λ™λ€λ¬Έκµ¬", "μ„μΈνΉλ³„μ‹ λ™λ€λ¬Έκµ¬ μ²νΈλ€λ΅2κΈΈ 23-9", 37.575294, 127.023249],
    ["μ¤‘λ‘κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "μ¤‘λ‘κµ¬", "μ„μΈνΉλ³„μ‹ μ¤‘λ‘κµ¬ μ©λ§μ‚°λ΅ 217", 37.579624, 127.094595],
    ["μ„±λ¶κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "μ„±λ¶κµ¬", "μ„μΈνΉλ³„μ‹ μ„±λ¶κµ¬ μ •λ¦‰λ΅ 242", 37.600609, 127.009388],
    ["μ„±λ¶κµ¬μ„κ΄€μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "μ„±λ¶κµ¬", "μ„μΈνΉλ³„μ‹ μ„±λ¶κµ¬ λκ³¶μ΄λ΅ 18κΈΈ 3-9", 37.610196, 127.064567],
    ["κ°•λ¶κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "κ°•λ¶κµ¬", "μ„μΈνΉλ³„μ‹ κ°•λ¶κµ¬ 4.19λ΅ 74", 37.644161, 127.013580],
    ["λ„λ΄‰κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "λ„λ΄‰κµ¬", "μ„μΈνΉλ³„μ‹ λ„λ΄‰κµ¬ λ…Έν•΄λ΅ 69κΈΈ 132", 37.649313, 127.050419],
    ["λ…Έμ›κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "λ…Έμ›κµ¬", "μ„μΈνΉλ³„μ‹ λ…Έμ›κµ¬ μλ½μ‚°λ΅212-19", 37.669865, 127.062013],
    ["μ€ν‰κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "μ€ν‰κµ¬", "μ„μΈνΉλ³„μ‹ μ€ν‰κµ¬ λ°±λ ¨μ‚°λ΅ 4κΈΈ 16", 37.595995, 126.924844],
    ["μ„λ€λ¬Έκµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "μ„λ€λ¬Έκµ¬", "μ„μΈνΉλ³„μ‹ μ„λ€λ¬Έκµ¬ μ¦κ°€λ΅30κΈΈ 45-9", 37.575033, 126.923838],
    ["λ§ν¬κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "λ§ν¬κµ¬", "μ„μΈνΉλ³„μ‹ λ§ν¬κµ¬ ν¬μ°μ •λ΅ 77", 37.550186, 126.914264],
    ["μ–‘μ²κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "μ–‘μ²κµ¬", "μ„μΈνΉλ³„μ‹ μ–‘μ²κµ¬ λ‚¨λ¶€μν™λ΅83κΈΈ 53", 37.525624, 126.839847],
    ["κ°•μ„κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "κ°•μ„κµ¬", "μ„μΈνΉλ³„μ‹ κ°•μ„κµ¬ ν™”κ³΅λ΅ 18κΈΈ 14-5", 37.539655, 126.852447],
    ["κµ¬λ΅κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "κµ¬λ΅κµ¬", "μ„μΈνΉλ³„μ‹ κµ¬λ΅κµ¬ μ¤λ¦¬λ΅ 1115", 37.487042, 126.814343],
    ["κΈμ²κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "κΈμ²κµ¬", "μ„μΈνΉλ³„μ‹ κΈμ²κµ¬ λ…μ‚°λ΅32λ‹¤κΈΈ 17", 37.457813, 126.901616],
    ["μλ“±ν¬κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "μλ“±ν¬κµ¬", "μ„μΈνΉλ³„μ‹ μλ“±ν¬κµ¬ λ„μλ΅22κΈΈ 36", 37.524957, 126.902279],
    ["λ™μ‘κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "λ™μ‘κµ¬", "μ„μΈνΉλ³„μ‹ λ™μ‘κµ¬ μ—¬μλ€λ°©λ΅ 20κΈΈ 61", 37.492067, 126.927237],
    ["κ΄€μ•…κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "κ΄€μ•…κµ¬", "μ„μΈνΉλ³„μ‹ κ΄€μ•…κµ¬ λ‚¨λ¶€μν™λ΅ 234κΈΈ 73", 37.484294, 126.931754],
    ["μ„μ΄κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "μ„μ΄κµ¬", "μ„μΈνΉλ³„μ‹ μ„μ΄κµ¬ λ°©λ°°λ΅5κΈΈ 11", 37.486241, 126.989012],
    ["κ°•λ‚¨κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "κ°•λ‚¨κµ¬", "μ„μΈνΉλ³„μ‹ κ°•λ‚¨κµ¬ κ΄‘ν‰λ΅ 144", 37.487532, 127.1017],
    ["μ†΅νκµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "μ†΅νκµ¬", "μ„μΈνΉλ³„μ‹ μ†΅νκµ¬ μ¤‘λ€λ΅ 4κΈΈ 4", 37.502934, 127.108922],
    ["κ°•λ™κµ¬μ²­μ†λ…„μƒλ‹΄λ³µμ§€μ„Όν„°", "μ„μΈνΉλ³„μ‹", "κ°•λ™κµ¬", "μ„μΈνΉλ³„μ‹ κ°•λ™κµ¬ μ•„λ¦¬μλ΅93κΈΈ 47", 37.553258, 127.170669],
]

columns = ["μ„Όν„°λ…", "μ‹λ„λ…", "μ‹κµ°κµ¬λ…", "μ£Όμ†", "μ„λ„", "κ²½λ„"]
df = pd.DataFrame(data, columns=columns)

st.title("π“ λ‚΄ μ„μΉμ—μ„ κ°€κΉμ΄ μ²­μ†λ…„ μƒλ‹΄μ„Όν„° μ°ΎκΈ°")

# λΈλΌμ°μ € μ„μΉ κ¶ν• μ”μ²­
st.subheader("π§­ λ‚΄ μ„μΉ μλ™ κ°€μ Έμ¤κΈ°")
st.markdown("λ‹¤μ μ„μΉ λ²„νΌμ„ ν΄λ¦­ν•΄ λΈλΌμ°μ €μ—μ„ μ„μΉλ¥Ό λ°›μ•„μµλ‹λ‹¤.")

# JavaScript μ‚½μ…ν•μ—¬ λΈλΌμ°μ € μ„μΉ κ°€μ Έμ¤κΈ°
st.components.v1.html("""
    <script>
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const coords = {
                lat: position.coords.latitude,
                lon: position.coords.longitude
            };
            const iframe = window.parent.document.querySelector('iframe');
            iframe.contentWindow.postMessage(coords, '*');
        },
        function(error) {
            console.error('μ„μΉ μ •λ³΄λ¥Ό κ°€μ Έμ¤λ” λ° μ‹¤ν¨ν–μµλ‹λ‹¤.', error);
        });
    </script>
""", height=0)

# κΈ°λ³Έ μ„μΉ
if "user_lat" not in st.session_state:
    st.session_state.user_lat = 37.5665
if "user_lon" not in st.session_state:
    st.session_state.user_lon = 126.9780

# μ„μΉ λ°μ΄ν„° μμ‹ 
def handle_location():
    import streamlit_javascript as stj
    coords = stj.st_javascript("window.addEventListener('message', (e) => window._coords = e.data);
                                 window._coords")
    if coords and "lat" in coords and "lon" in coords:
        st.session_state.user_lat = coords["lat"]
        st.session_state.user_lon = coords["lon"]
handle_location()

user_lat = st.session_state.user_lat
user_lon = st.session_state.user_lon

# κ±°λ¦¬ κ³„μ‚° ν•¨μ
def get_nearest_center(user_lat, user_lon):
    df["κ±°λ¦¬"] = df.apply(lambda row: geodesic((user_lat, user_lon), (row["μ„λ„"], row["κ²½λ„"])).km, axis=1)
    nearest = df.sort_values("κ±°λ¦¬").iloc[0]
    return nearest

nearest = get_nearest_center(user_lat, user_lon)

# κ²°κ³Ό ν‘μ‹
st.success(f"\nκ°€μ¥ κ°€κΉμ΄ μƒλ‹΄μ„Όν„°λ” **{nearest['μ„Όν„°λ…']}** μ…λ‹λ‹¤!\n\nπ“ μ£Όμ†: {nearest['μ£Όμ†']}\n\nπ›£οΈ κ±°λ¦¬: {nearest['κ±°λ¦¬']:.2f} km")

# μ§€λ„ μƒμ„±
m = folium.Map(location=[user_lat, user_lon], zoom_start=12)
folium.Marker([user_lat, user_lon], tooltip="λ‚΄ μ„μΉ", icon=folium.Icon(color="blue")).add_to(m)

# λ¨λ“  μ„Όν„° λ§μ»¤ ν‘μ‹
for _, row in df.iterrows():
    folium.Marker(
        [row["μ„λ„"], row["κ²½λ„"]],
        tooltip=row["μ„Όν„°λ…"],
        icon=folium.Icon(color="green")
    ).add_to(m)

# κ°€μ¥ κ°€κΉμ΄ μ„Όν„° κ°•μ΅°
folium.Marker(
    [nearest["μ„λ„"], nearest["κ²½λ„"]],
    tooltip=f"κ°€μ¥ κ°€κΉμ΄ μ„Όν„°: {nearest['μ„Όν„°λ…']}",
    icon=folium.Icon(color="red", icon="star")
).add_to(m)

st.subheader("π—ΊοΈ μ§€λ„ λ³΄κΈ°")
st_folium(m, width=800, height=500)
